version: 2.1
executors:
  node-executor:
    docker:
      - image: circleci/node:10.15
    working_directory: ~/repo

jobs:
  bump-version-or-deploy:
    executor: node-executor
    environment:
      - GIT_BASE_REVISION: << pipeline.git.base_revision >>
      - GIT_CURRENT_REVISION: << pipeline.git.revision >>
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "47:59:56:60:06:a3:38:a0:35:b8:a2:46:5f:47:b3:e5"
      - run:
          name: "pick out lerna version commit"
          command: |
            git config --global user.email "developer@twreporter.org"
            git config --global user.name "reporterdev"
            STABLE_BRANCH_NAME="release-at-${GIT_CURRENT_REVISION:0:6}"
            echo "Creating stable release branch $STABLE_BRANCH_NAME"
            git checkout -b "$STABLE_BRANCH_NAME"
            echo "test file" >> TEST_FILE
            git add TEST_FILE
            git commit -m "chore: add test-file"
            git push -u origin "$STABLE_BRANCH_NAME"
            curl "https://api.github.com/repos/twreporter/twreporter-npm-packages/pulls" \
              -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              --data @<(cat \<<EOF
                {
                  "title": "chore(release): bump version",
                  "head": "$STABLE_BRANCH_NAME",
                  "base": "master",
                  "body": "Release stable version. Submit from CircleCI build [#$CIRCLE_BUILD_NUM](https://circleci.com/gh/twreporter/twreporter-npm-packages/$CIRCLE_BUILD_NUM)."
                }
              EOF
              )
              

workflows:
  version: 2.1
  bump_version_or_deploy:
    jobs:
      - bump-version-or-deploy:
          filters:
            branches:
              only: ci-dev
